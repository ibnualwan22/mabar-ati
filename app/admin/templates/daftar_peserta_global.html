{% extends "_admin_layout.html" %}

{% block title %}Data Peserta Global{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Data Peserta Global</h1>
</div>
<p>Halaman ini menampilkan semua santri yang telah terdaftar di semua rombongan untuk edisi yang sedang aktif.</p>

<div class="card">
    <div class="card-header">
        <h5>Filter Data Peserta</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin.daftar_peserta_global') }}">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="nama" class="form-control" placeholder="Cari Nama Santri..." value="{{ request.args.get('nama', '') }}">
                </div>
                <div class="col-md-4">
                    <select name="rombongan_id" class="form-select">
                        <option value="">-- Semua Rombongan --</option>
                        {% for rombongan in all_rombongan %}
                            <option value="{{ rombongan.id }}" {% if request.args.get('rombongan_id')|int == rombongan.id %}selected{% endif %}>
                                {{ rombongan.nama_rombongan }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <select name="status_bayar" class="form-select">
                        <option value="">-- Semua Status Bayar --</option>
                        <option value="Lunas" {% if request.args.get('status_bayar') == 'Lunas' %}selected{% endif %}>Lunas</option>
                        <option value="Belum Lunas" {% if request.args.get('status_bayar') == 'Belum Lunas' %}selected{% endif %}>Belum Lunas</option>
                    </select>
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary">Filter</button>
                    <a href="{{ url_for('admin.daftar_peserta_global') }}" class="btn btn-secondary">Reset</a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5>Daftar Peserta (Total: {{ pagination.total }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead>
            <tr>
                <th>No.</th>
                <th>Nama Santri</th>
                <th>Rombongan</th>
                <th>Titik Turun & Jemput</th>
                <th>Bus Pulang</th>
                <th>Bus Kembali</th>
                <th>Status Bayar</th>
                <th>Total Biaya</th>
            </tr>
        </thead>
        <tbody>
            {% for pendaftaran in pagination.items %}
            <tr>
                <td>{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                <td>
                    <strong>{{ pendaftaran.santri.nama }}</strong><br>
                    <small class="text-muted">NIS: {{ pendaftaran.santri.nis }}</small>
                </td>
                <td>
                    {# Menampilkan nama rombongan pulang sebagai acuan utama #}
                    {{ pendaftaran.rombongan_pulang.nama_rombongan if pendaftaran.rombongan_pulang else 'N/A' }}
                </td>
                <td>
                    Turun: {{ pendaftaran.titik_turun or '-' }}<br>
                    <small class="text-muted">Jemput: {{ pendaftaran.titik_jemput_kembali or pendaftaran.titik_turun or '-' }}</small>
                </td>
                <td>
                    {% if pendaftaran.bus_pulang %}
                        <span class="badge bg-info text-dark">
                            {{ pendaftaran.bus_pulang.nama_armada }} ({{ pendaftaran.bus_pulang.nomor_lambung or pendaftaran.bus_pulang.plat_nomor }})
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if pendaftaran.bus_kembali %}
                        <span class="badge bg-info text-dark">
                            {{ pendaftaran.bus_kembali.nama_armada }} ({{ pendaftaran.bus_kembali.nomor_lambung or pendaftaran.bus_kembali.plat_nomor }})
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge bg-success">Pulang: {{ pendaftaran.status_pulang }}</span><br>
                    <span class="badge bg-warning text-dark mt-1">Kembali: {{ pendaftaran.status_kembali }}</span>
                </td>
                <td>Rp {{ "{:,.0f}".format(pendaftaran.total_biaya).replace(',', '.') }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center">Tidak ada data peserta yang cocok dengan filter Anda.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}