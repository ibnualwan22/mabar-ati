{% extends "_admin_layout.html" %}

{% block title %}Detail Bus: {{ bus.nama_armada }} {{ bus.nomor_lambung }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h2">Detail Bus & Manifest</h1>
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">&larr; Kembali ke Dashboard</a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h4>{{ bus.nama_armada }} - {{ bus.nomor_lambung or bus.plat_nomor }}</h4>
    </div>
    <div class="card-body">
        <p><strong>Rombongan:</strong> {{ bus.rombongan.nama_rombongan }}</p>
        <p><strong>Plat Nomor:</strong> {{ bus.plat_nomor or '-' }}</p>
        <p><strong>Keterangan:</strong> {{ bus.keterangan or '-' }}</p>
        <hr>
<p class="h5">Kapasitas Pulang: <span class="fw-bold">{{ jumlah_peserta_pulang }} / {{ bus.kuota }}</span> Terisi</p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5>Manifest Perjalanan Pulang (Meninggalkan Pondok)</h5>
    </div>
    <div class="card-body">
        {% if grouped_peserta_pulang %}
            {% for titik_turun, pendaftar_list in grouped_peserta_pulang.items()|sort %}
            <div class="mb-4">
                <h6><strong>Titik Turun: {{ titik_turun }}</strong> (Jumlah: {{ pendaftar_list|length }})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead><tr><th>No.</th><th>Nama Santri</th><th>NIS</th><th>Asrama</th></tr></thead>
                        <tbody>
                            {% for p in pendaftar_list|sort(attribute='santri.nama') %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ p.santri.nama }}</td>
                                <td>{{ p.santri.nis }}</td>
                                <td>{{ p.santri.asrama }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-center">Tidak ada peserta untuk perjalanan pulang di bus ini.</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5>Manifest Perjalanan Kembali (Menuju Pondok)</h5>
    </div>
    <div class="card-body">
        <p>
            <strong>Jadwal Kembali:</strong> {{ bus.rombongan.jadwal_kembali|datetime_wib if bus.rombongan.jadwal_kembali else 'Belum diatur' }}<br>
            <strong>Titik Kumpul Kembali:</strong> {{ bus.rombongan.titik_kumpul_kembali or 'Belum diatur' }}
        </p>
        <p class="h5">Kapasitas Kembali: <span class="fw-bold">{{ jumlah_peserta_kembali }} / {{ bus.kuota }}</span> Terisi</p>
        <hr>

        {% if grouped_peserta_kembali %}
            {% for titik_jemput, pendaftar_list in grouped_peserta_kembali.items()|sort %}
            <div class="mb-4">
                <h6><strong>Titik Jemput (Referensi): {{ titik_jemput or 'Tidak Diketahui' }}</strong> (Jumlah: {{ pendaftar_list|length }})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Santri</th>
                                <th>Alamat</th>
                                <th>Asrama</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in pendaftar_list|sort(attribute='santri.nama') %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ p.santri.nama }}</td>
                                <td>{{ p.santri.kabupaten }}</td>
                                <td>{{ p.santri.asrama }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-center">Tidak ada peserta untuk perjalanan kembali di bus ini.</p>
        {% endif %}
    </div>
</div>
{% endblock %}