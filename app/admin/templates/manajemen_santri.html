{% extends "_admin_layout.html" %}

{% block title %}Manajemen Santri{% endblock %}

{% block content %}
<style>
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: .375rem;
    }
    .status-badge {
        font-size: 0.8em;
        font-weight: 600;
        padding: 0.35em 0.65em;
        border-radius: .375rem;
    }
    .status-aktif { background-color: #d1e7dd; color: #0f5132; }
    .status-izin { background-color: #fff3cd; color: #664d03; }
    .status-partisipan { background-color: #cff4fc; color: #055160; }
    .status-terdaftar { background-color: #e2e3e5; color: #41464b; }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manajemen Santri</h1>
</div>
<p>Halaman ini berisi semua data santri yang sudah diimpor ke dalam sistem. Klik `[+ Daftarkan]` untuk memasukkan santri ke dalam rombongan.</p>

<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-filter me-2"></i>Filter & Aksi</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin.manajemen_santri') }}" class="filter-form">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" name="nama" class="form-control" placeholder="Cari Nama Santri..." value="{{ request.args.get('nama', '') }}">
                </div>
                <div class="col-md-3">
                    <select id="filter-alamat" name="alamat" multiple placeholder="Filter Alamat..."></select>
                </div>
                <div class="col-md-3">
                    <select name="status" class="form-select">
                        <option value="">-- Semua Status Santri --</option>
                        <option value="Aktif" {% if request.args.get('status') == 'Aktif' %}selected{% endif %}>Aktif</option>
                        <option value="Izin" {% if request.args.get('status') == 'Izin' %}selected{% endif %}>Izin</option>
                        <option value="Partisipan" {% if request.args.get('status') == 'Partisipan' %}selected{% endif %}>Partisipan</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="rombongan_id" class="form-select">
                        <option value="">-- Semua Rombongan --</option>
                        <option value="belum_terdaftar" {% if request.args.get('rombongan_id') == 'belum_terdaftar' %}selected{% endif %}>Belum Terdaftar</option>
                        {% for rombongan in all_rombongan %}
                            <option value="{{ rombongan.id }}" {% if request.args.get('rombongan_id')|int == rombongan.id %}selected{% endif %}>{{ rombongan.nama_rombongan }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search me-2"></i>Filter</button>
                    <a href="{{ url_for('admin.manajemen_santri') }}" class="btn btn-secondary"><i class="fas fa-undo me-2"></i>Reset</a>
                </div>
            </div>
        </form>
        <hr>
        <div class="action-buttons">
            {% if current_user.role.name == 'Korpus' %}
                <button id="open-impor-modal" class="btn btn-success"><i class="fas fa-user-plus me-2"></i>Impor Santri Individual</button>
                <form method="POST" action="{{ url_for('admin.impor_semua_santri') }}" style="display: inline-block;" onsubmit="return confirm('Proses ini akan memakan waktu. Lanjutkan?');">
                    <button type="submit" class="btn btn-info"><i class="fas fa-sync-alt me-2"></i>Impor & Sinkronkan Semua</button>
                </form>
            {% endif %}
        </div>
    </div>
</div>


<div class="card">
    <div class="card-header">
        <h5>Daftar Santri (Total: {{ pagination.total }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Nama Santri</th>
                        <th>Asrama & Alamat</th>
                        <th>Detail Kelas</th>
                        <th>Status Santri</th>
                        <th>Detail Rombongan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for santri in pagination.items %}
                    <tr>
                        <td>{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                        <td>
                            <strong>{{ santri.nama }}</strong><br>
                            <small class="text-muted">NIS: {{ santri.nis }}</small>
                        </td>
                        <td>
                            {{ santri.asrama or '-' }}<br>
                            <small class="text-muted">{{ santri.kabupaten or '-' }}</small>
                        </td>
                        <td>
                            Formal: {{ santri.kelas_formal or '-' }}<br>
                            <small class="text-muted">Ngaji: {{ santri.kelas_ngaji or '-' }}</small>
                        </td>
                        <td>
                            {% if santri.status_santri == 'Aktif' %}
                                <span class="status-badge status-aktif">Aktif</span>
                            {% elif santri.status_santri == 'Izin' %}
                                <span class="status-badge status-izin">Izin</span>
                            {% elif santri.status_santri == 'Partisipan' %}
                                <span class="status-badge status-partisipan">Partisipan</span>
                            {% else %}
                                <span class="status-badge">{{ santri.status_santri }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if santri.pendaftaran %}
                                Pulang: <strong>{{ santri.pendaftaran.rombongan_pulang.nama_rombongan if santri.pendaftaran.rombongan_pulang else 'N/A' }}</strong><br>
                                <small class="text-muted">Kembali: <strong>{{ santri.pendaftaran.rombongan_kembali.nama_rombongan if santri.pendaftaran.rombongan_kembali else 'N/A' }}</strong></small>
                            {% else %}
                                <span class="status-badge status-terdaftar">Belum Terdaftar</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if current_user.role.name in ['Korpus', 'Korda'] %}
                                {% if santri.pendaftaran %}
                                    <a href="{{ url_for('admin.edit_pendaftaran', pendaftaran_id=santri.pendaftaran.id) }}" class="btn btn-secondary btn-sm">Edit Daftar</a>
                                {% else %}
                                    <a href="{{ url_for('admin.pendaftaran_rombongan', santri_id=santri.id) }}" class="btn btn-primary btn-sm">+ Daftarkan</a>
                                {% endif %}
                            {% endif %}

                            {% if current_user.role.name == 'Korpus' %}
                            <form method="POST" action="{{ url_for('admin.hapus_santri', id=santri.id) }}" class="mt-1" onsubmit="return confirm('Anda yakin ingin menghapus \'{{ santri.nama }}\' dari sistem lokal?');">
                                <button type="submit" class="btn btn-danger btn-sm">Hapus</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center">Tidak ada santri yang cocok dengan filter Anda.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-4 d-flex justify-content-center">
            {% set args = request.args.to_dict() %}
            {% do args.pop('page', None) %}
            <ul class="pagination">
                <li class="page-item {{ 'disabled' if not pagination.has_prev }}"><a class="page-link" href="{{ url_for('admin.manajemen_santri', page=pagination.prev_num, **args) }}">&laquo;</a></li>
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {{ 'active' if pagination.page == page_num else '' }}"><a class="page-link" href="{{ url_for('admin.manajemen_santri', page=page_num, **args) }}">{{ page_num }}</a></li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {{ 'disabled' if not pagination.has_next }}"><a class="page-link" href="{{ url_for('admin.manajemen_santri', page=pagination.next_num, **args) }}">&raquo;</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="impor-modal" class="modal">...</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('impor-modal');
    const openModalBtn = document.getElementById('open-impor-modal');
    const closeModalBtn = modal.querySelector('.close-btn');
    const searchInput = document.getElementById('search-santri-input');
    const resultsContainer = document.getElementById('search-results-container');
    let debounceTimer;

    openModalBtn.onclick = () => { modal.style.display = 'block'; searchInput.focus(); };
    closeModalBtn.onclick = () => { modal.style.display = 'none'; };
    window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };
    new TomSelect('#filter-alamat',{
    plugins: ['remove_button'],
});

    searchInput.addEventListener('keyup', (e) => {
        clearTimeout(debounceTimer);
        const query = e.target.value;
        if (query.length < 3) {
            resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Ketik minimal 3 huruf.</p>';
            return;
        }
        resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Mencari...</p>';
        debounceTimer = setTimeout(() => {
            fetch(`/admin/api/search-student?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    renderResults(data.data);
                });
        }, 500);
    });

    function renderResults(santriList) {
        resultsContainer.innerHTML = '';
        if (!santriList || santriList.length === 0) {
            resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Santri tidak ditemukan.</p>';
            return;
        }
        santriList.forEach(santri => {
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `
                <div>
                    <strong>${santri.name}</strong><br>
                    <small>NIS: ${santri.nis || 'N/A'} | Asrama: ${santri.activeDormitory || 'N/A'}</small>
                </div>
                <button class="btn btn-primary impor-btn">+ Impor</button>
            `;
            item.querySelector('.impor-btn').dataset.santri = JSON.stringify(santri);
            resultsContainer.appendChild(item);
        });
    }
    
    resultsContainer.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('impor-btn')) {
            const btn = e.target;
            const santriData = JSON.parse(btn.dataset.santri);
            btn.textContent = 'Memproses...';
            btn.disabled = true;

            fetch('/admin/santri/impor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(santriData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    btn.textContent = 'Berhasil';
                    btn.style.backgroundColor = '#28a745';
                } else {
                    btn.textContent = result.message;
                    btn.style.backgroundColor = '#dc3545';
                }
            });
        }
    });
});
</script>
{% endblock %}