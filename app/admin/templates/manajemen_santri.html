{% extends "_admin_layout.html" %}

{% block title %}Manajemen Santri{% endblock %}

{% block content %}
<style>
    /* CSS untuk Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 60%; border-radius: 8px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;}
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .search-results { max-height: 400px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; }
    .result-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    .result-item:last-child { border-bottom: none; }
    .result-item button:disabled { background-color: #28a745; cursor: not-allowed; }
    
    /* CSS untuk Filter & Tabel */
    .filter-form { margin-bottom: 20px; }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: center; }
    .filter-grid input, .filter-grid select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    .action-buttons { margin-top: 20px; margin-bottom: 20px; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    .pagination { margin-top: 20px; text-align: center; }
</style>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Manajemen Santri</h1>
</div>
<p>Halaman ini berisi semua data santri yang sudah diimpor ke dalam sistem.</p>

<hr>
<h3>Filter & Aksi</h3>
<form method="GET" action="{{ url_for('admin.manajemen_santri') }}" class="filter-form">
    <div class="filter-grid">
        <input type="text" name="nama" placeholder="Cari Nama..." value="{{ request.args.get('nama', '') }}">
        <input type="text" name="asrama" placeholder="Cari Asrama..." value="{{ request.args.get('asrama', '') }}">
        <select name="status">
            <option value="">-- Semua Status Santri --</option>
            <option value="Aktif" {% if request.args.get('status') == 'Aktif' %}selected{% endif %}>Aktif</option>
            <option value="Izin" {% if request.args.get('status') == 'Izin' %}selected{% endif %}>Izin</option>
            <option value="Partisipan" {% if request.args.get('status') == 'Partisipan' %}selected{% endif %}>Partisipan</option>
            <option value="Wisuda" {% if request.args.get('status') == 'Wisuda' %}selected{% endif %}>Wisuda</option>
        </select>
        
        <select name="rombongan_id">
            <option value="">-- Semua Rombongan --</option>
            <option value="belum_terdaftar" {% if request.args.get('rombongan_id') == 'belum_terdaftar' %}selected{% endif %}>Belum Terdaftar</option>
            {% for rombongan in all_rombongan %}
                <option value="{{ rombongan.id }}" {% if request.args.get('rombongan_id')|int == rombongan.id %}selected{% endif %}>
                    {{ rombongan.nama_rombongan }}
                </option>
            {% endfor %}
        </select>
        
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="{{ url_for('admin.manajemen_santri') }}" class="btn btn-secondary">Reset</a>
    </div>
</form>
<div class="action-buttons">
    <button id="open-impor-modal" class="btn btn-primary">[+ Impor Santri Individual]</button>
    <form method="POST" action="{{ url_for('admin.impor_semua_santri') }}" style="display: inline-block;" onsubmit="return confirm('Proses ini akan mengambil semua data dari server induk dan mungkin membutuhkan waktu. Lanjutkan?');">
        <button type="submit" class="btn btn-secondary">[Impor & Sinkronkan Semua Santri]</button>
    </form>
</div>
<hr>

<h3>Daftar Santri Tersimpan (Total: {{ pagination.total }})</h3>
<div style="overflow-x: auto;">
    <table style="width: 100%; min-width: 1400px;">
        <thead>
            <tr>
                <th>No.</th>
                <th>Nama Santri</th>
                <th>NIS</th>
                <th>Asrama</th>
                <th>Alamat</th>
                <th>Kelas Formal</th>
                <th>Kelas Ngaji</th>
                <th>Status Santri</th>
                <th>Rombongan</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for santri in pagination.items %}
            <tr>
                <td>{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                <td>{{ santri.nama }}</td>
                <td>{{ santri.nis }}</td>
                <td>{{ santri.asrama or '-' }}</td>
                <td>{{ santri.kabupaten or '-' }}</td>
                <td>{{ santri.kelas_formal or '-' }}</td>
                <td>{{ santri.kelas_ngaji or '-' }}</td>
                <td>{{ santri.status_santri }}</td>
                <td>
                    {% if santri.pendaftaran %}
                        <span style="font-weight: bold; color: green;">{{ santri.pendaftaran.rombongan.nama_rombongan }}</span>
                    {% else %}
                        <span style="color: #888;">Belum Terdaftar</span>
                    {% endif %}
                </td>
                <td>
    {% if santri.pendaftaran %}
        <a href="{{ url_for('admin.edit_pendaftaran', pendaftaran_id=santri.pendaftaran.id) }}" class="btn btn-secondary action-btn">Edit Pendaftaran</a>
    {% else %}
        <a href="{{ url_for('admin.pendaftaran_rombongan', santri_id=santri.id) }}" class="btn btn-primary action-btn">+ Daftarkan</a>
    {% endif %}
    
    <form method="POST" action="{{ url_for('admin.hapus_santri', id=santri.id) }}" style="display:inline;" onsubmit="return confirm('Anda yakin ingin menghapus \'{{ santri.nama }}\' dari sistem lokal?');">
        <button type="submit" class="btn btn-danger action-btn">Hapus</button>
    </form>
</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="10" style="text-align: center;">Tidak ada santri yang cocok dengan filter Anda.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="pagination" style="margin-top: 20px; text-align: center;">
    {# Siapkan argumen filter tanpa 'page' #}
    {% set args = request.args.to_dict() %}
    {% do args.pop('page', None) %}

    {% if pagination.has_prev %}
        <a href="{{ url_for('admin.manajemen_santri', page=pagination.prev_num, **args) }}" class="btn btn-secondary">&laquo; Sebelumnya</a>
    {% endif %}

    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
        {% if page_num %}
            {% if pagination.page == page_num %}
                <a href="#" class="btn btn-primary">{{ page_num }}</a>
            {% else %}
                <a href="{{ url_for('admin.manajemen_santri', page=page_num, **args) }}" class="btn btn-secondary">{{ page_num }}</a>
            {% endif %}
        {% else %}
            ...
        {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
        <a href="{{ url_for('admin.manajemen_santri', page=pagination.next_num, **args) }}" class="btn btn-secondary">Berikutnya &raquo;</a>
    {% endif %}
</div>

<div id="impor-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Cari & Impor Santri</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div>
            <input type="text" id="search-santri-input" placeholder="Ketik nama santri..." style="width: 100%; padding: 10px; font-size: 1em;">
            <div class="search-results" id="search-results-container">
                <p style="text-align: center; color: #888;">Ketik nama untuk memulai pencarian.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('impor-modal');
    const openModalBtn = document.getElementById('open-impor-modal');
    const closeModalBtn = modal.querySelector('.close-btn');
    const searchInput = document.getElementById('search-santri-input');
    const resultsContainer = document.getElementById('search-results-container');
    let debounceTimer;

    openModalBtn.onclick = () => { modal.style.display = 'block'; searchInput.focus(); };
    closeModalBtn.onclick = () => { modal.style.display = 'none'; };
    window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };

    searchInput.addEventListener('keyup', (e) => {
        clearTimeout(debounceTimer);
        const query = e.target.value;
        if (query.length < 3) {
            resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Ketik minimal 3 huruf.</p>';
            return;
        }
        resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Mencari...</p>';
        debounceTimer = setTimeout(() => {
            fetch(`/admin/api/search-student?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    renderResults(data.data);
                });
        }, 500);
    });

    function renderResults(santriList) {
        resultsContainer.innerHTML = '';
        if (!santriList || santriList.length === 0) {
            resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Santri tidak ditemukan.</p>';
            return;
        }
        santriList.forEach(santri => {
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `
                <div>
                    <strong>${santri.name}</strong><br>
                    <small>NIS: ${santri.nis || 'N/A'} | Asrama: ${santri.activeDormitory || 'N/A'}</small>
                </div>
                <button class="btn btn-primary impor-btn">+ Impor</button>
            `;
            item.querySelector('.impor-btn').dataset.santri = JSON.stringify(santri);
            resultsContainer.appendChild(item);
        });
    }
    
    resultsContainer.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('impor-btn')) {
            const btn = e.target;
            const santriData = JSON.parse(btn.dataset.santri);
            btn.textContent = 'Memproses...';
            btn.disabled = true;

            fetch('/admin/santri/impor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(santriData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    btn.textContent = 'Berhasil';
                    btn.style.backgroundColor = '#28a745';
                } else {
                    btn.textContent = result.message;
                    btn.style.backgroundColor = '#dc3545';
                }
            });
        }
    });
});
</script>
{% endblock %}