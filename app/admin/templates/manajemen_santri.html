{% extends "_admin_layout.html" %}

{% block title %}Manajemen Santri{% endblock %}

{% block content %}
<style>
    /* CSS untuk Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 60%; border-radius: 8px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;}
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .search-results { max-height: 400px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; }
    .result-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    .result-item:last-child { border-bottom: none; }
    .result-item button:disabled { background-color: #28a745; cursor: not-allowed; }
    
    /* CSS untuk Filter & Tabel */
    .filter-form { margin-bottom: 20px; }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: center; }
    .filter-grid input, .filter-grid select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    .action-buttons { margin-top: 20px; margin-bottom: 20px; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    .pagination { margin-top: 20px; text-align: center; }
    @media (max-width: 800px) {
  .enhanced-table td, 
  .enhanced-table th {
    font-size: 0.75rem;       /* kecilkan teks */
    white-space: nowrap;      /* jangan bungkus teks ke bawah */
  }

  /* beri lebar minimum untuk kolom tertentu */
  .enhanced-table th:nth-child(2),
  .enhanced-table td:nth-child(2) {
    min-width: 140px; /* Data Santri */
  }
  .enhanced-table th:nth-child(3),
  .enhanced-table td:nth-child(3) {
    min-width: 120px; /* Rombongan */
  }
  .enhanced-table th:nth-child(4),
  .enhanced-table td:nth-child(4) {
    min-width: 150px; /* Titik Turun/Jemput */
  }
}

</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manajemen Santri</h1>
</div>
<p>Halaman ini berisi semua data santri yang sudah diimpor ke dalam sistem. Klik `[+ Daftarkan]` untuk memasukkan santri ke dalam rombongan.</p>

<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-filter me-2"></i>Filter & Aksi</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin.manajemen_santri') }}" class="filter-form">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" name="nama" class="form-control" placeholder="Cari Nama Santri..." value="{{ request.args.get('nama', '') }}">
                </div>
                <div class="col-md-3">
<select name="alamat" id="filter-alamat" multiple placeholder="Cari Alamat...">
    {% for kab in all_kabupaten %}
        <option value="{{ kab }}" {% if kab in request.args.getlist('alamat') %}selected{% endif %}>{{ kab }}</option>
    {% endfor %}
</select>
<datalist id="alamat-list"></datalist>
</div>
    <div class="col-md-2">
        <label for="keterangan" class="form-label">Keterangan</label>
        <select name="keterangan" id="keterangan" class="form-select">
            <option value="">-- Semua --</option>
            <option value="Santri" {% if request.args.get('keterangan') == 'Santri' %}selected{% endif %}>Santri</option>
            <option value="Pengurus" {% if request.args.get('keterangan') == 'Pengurus' %}selected{% endif %}>Pengurus</option>
        </select>
    </div>

                <div class="col-md-3">
                    <select name="status" class="form-select">
                        <option value="">-- Semua Status Santri --</option>
                        <option value="Aktif" {% if request.args.get('status') == 'Aktif' %}selected{% endif %}>Aktif</option>
                        <option value="Izin" {% if request.args.get('status') == 'Izin' %}selected{% endif %}>Izin</option>
                        <option value="Partisipan" {% if request.args.get('status') == 'Partisipan' %}selected{% endif %}>Partisipan</option>
                        <option value="Wisuda" {% if request.args.get('status') == 'Wisuda' %}selected{% endif %}>Wisuda</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="rombongan_id" class="form-select">
                        <option value="">-- Semua Rombongan --</option>
                        <option value="belum_terdaftar" {% if request.args.get('rombongan_id') == 'belum_terdaftar' %}selected{% endif %}>Belum Terdaftar</option>
                        {% for rombongan in all_rombongan %}
                            <option value="{{ rombongan.id }}" {% if request.args.get('rombongan_id')|int == rombongan.id %}selected{% endif %}>{{ rombongan.nama_rombongan }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search me-2"></i>Filter</button>
                    <a href="{{ url_for('admin.manajemen_santri') }}" class="btn btn-secondary"><i class="fas fa-undo me-2"></i>Reset</a>
                </div>
                <div class="col-md-3">
    <label for="provinsi" class="form-label">Provinsi</label>
    <select name="provinsi" id="provinsi" class="form-select">
        <option value="">-- Semua Provinsi --</option>
        {% for prov in all_provinsi %}
            <option value="{{ prov }}" {% if request.args.get('provinsi') == prov %}selected{% endif %}>
                {{ prov }}
            </option>
        {% endfor %}
    </select>
</div>
            </div>
        </form>
        <hr>
        <div class="action-buttons">
            {% if current_user.role.name == 'Korpus' %}
                <button id="open-impor-modal" class="btn btn-success">
    <i class="fas fa-user-plus me-2"></i>Impor Santri Individual
</button>

<form method="POST" action="{{ url_for('admin.impor_semua_santri') }}" style="display: inline-block;" onsubmit="return confirmDelete(this,'Proses ini akan memakan waktu. Lanjutkan?');">
    <button type="submit" class="btn btn-info">
        <i class="fas fa-sync-alt me-2"></i>Impor & Sinkronkan Semua
    </button>
</form>
            {% endif %}

        {% if current_user.role.name in ['Korpus', 'Korpuspi', 'Sekretaris'] %}
<a href="{{ url_for('admin.tambah_santri_manual') }}" class="btn btn-primary">
    <i class="fas fa-user-edit me-2"></i>Tambah Santri Manual
</a>
            {% endif %}
        </div>
    </div>
</div>


<div class="card">
    <div class="card-header">
        <h5>Daftar Santri Tersimpan (Total: {{ pagination.total }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Nama Santri</th>
                        <th>Asrama & Alamat</th>
                        <th>No. Wali</th>
                        <th>Keterangan</th>
                        <th>Detail Kelas</th>
                        <th>Status Santri</th>
                        <th>Detail Rombongan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for santri in pagination.items %}
                    <tr>
                        <td>{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                        <td>
                            <strong>{{ santri.nama }}</strong><br>
<small class="text-muted">
    {% if santri.jenis_kelamin == 'PUTRA' %}
        <span class="badge bg-success-subtle text-success">Putra</span>
    {% elif santri.jenis_kelamin == 'PUTRI' %}
        <span class="badge bg-info-subtle text-info">Putri</span>
    {% else %}
        {{ santri.jenis_kelamin }}
    {% endif %}

                        </td>
                        <td>
                            {{ santri.asrama or '-' }}<br>
                            <small class="text-muted">{{ santri.kabupaten or '-' }}</small>
                        </td>
                        <td>{{ santri.no_hp_wali or '-' }}</td>
<td>
    {% if santri.nama_jabatan %}
        <strong>{{ santri.nama_jabatan }}</strong><br>
        <small class="text-muted">
            {% if santri.status_jabatan == 'CHAIRMAN' %}
                Ketua
            {% else %}
                Anggota
            {% endif %}
        </small>
    {% else %}
        <strong>Santri</strong><br>
        <small class="text-muted">-</small>
    {% endif %}
</td>
                        <td>
                            Formal: {{ santri.kelas_formal or '-' }}<br>
                            <small class="text-muted">Ngaji: {{ santri.kelas_ngaji or '-' }}</small>
                        </td>
                        <td>
                            {% if santri.status_santri == 'Aktif' %}
                                <span class="badge bg-success">Aktif</span>
                            {% elif santri.status_santri == 'Izin' %}
                                <span class="badge bg-warning text-dark">Izin</span>
                            {% elif santri.status_santri == 'Partisipan' %}
                                <span class="badge bg-info text-dark">Partisipan</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ santri.status_santri }}</span>
                            {% endif %}
                        </td>
                        <td>
        {# Ambil data pendaftaran yang relevan dari dictionary #}
        {% set pendaftaran = pendaftaran_terkait.get(santri.id) %}
        
        {% if pendaftaran %}
            Pulang: <strong>{{ pendaftaran.rombongan_pulang.nama_rombongan if pendaftaran.rombongan_pulang else 'N/A' }}</strong><br>
            <small class="text-muted">Kembali: <strong>{{ pendaftaran.rombongan_kembali.nama_rombongan if pendaftaran.rombongan_kembali else 'N/A' }}</strong></small>
        {% else %}
            <span class="badge bg-light text-dark">Belum Terdaftar</span>
        {% endif %}
    </td>
                        <td>
        {% set pendaftaran = pendaftaran_terkait.get(santri.id) %}
        {% if pendaftaran %}
            <a href="{{ url_for('admin.edit_pendaftaran', pendaftaran_id=pendaftaran.id) }}" class="btn btn-secondary btn-sm">Edit Daftar</a>
        {% else %}
             <a href="{{ url_for('admin.pendaftaran_rombongan', santri_id=santri.id) }}" class="btn btn-primary btn-sm">+ Daftarkan</a>
        {% endif %}

        {% if current_user.role.name in ['Korpus', 'Korpuspi'] %}
                            <form method="POST" action="{{ url_for('admin.hapus_santri', id=santri.id) }}" class="mt-1" onsubmit="return confirmDelete(this,'Anda yakin ingin menghapus \'{{ santri.nama }}\' dari sistem lokal?');">
                                <button type="submit" class="btn btn-danger btn-sm">Hapus</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center">Tidak ada santri yang cocok dengan filter Anda.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-4 d-flex justify-content-center">
            {% set args = request.args.to_dict() %}
            {% do args.pop('page', None) %}
            <ul class="pagination">
                <li class="page-item {{ 'disabled' if not pagination.has_prev }}"><a class="page-link" href="{{ url_for('admin.manajemen_santri', page=pagination.prev_num, **args) }}">&laquo;</a></li>
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {{ 'active' if pagination.page == page_num else '' }}"><a class="page-link" href="{{ url_for('admin.manajemen_santri', page=page_num, **args) }}">{{ page_num }}</a></li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {{ 'disabled' if not pagination.has_next }}"><a class="page-link" href="{{ url_for('admin.manajemen_santri', page=pagination.next_num, **args) }}">&raquo;</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="impor-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Cari & Impor Santri</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div>
            <input type="text" id="search-santri-input" placeholder="Ketik nama santri..." style="width: 100%; padding: 10px; font-size: 1em;">
            <div class="search-results" id="search-results-container">
                <p style="text-align: center; color: #888;">Ketik nama untuk memulai pencarian.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('impor-modal');
    if (modal) {
        const openModalBtn = document.getElementById('open-impor-modal');
        const closeModalBtn = modal.querySelector('.close-btn');
        const searchInput = document.getElementById('search-santri-input');
        const resultsContainer = document.getElementById('search-results-container');
        let debounceTimer;

        openModalBtn.onclick = () => { modal.style.display = 'block'; searchInput.focus(); };
        closeModalBtn.onclick = () => { modal.style.display = 'none'; };
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };

        searchInput.addEventListener('keyup', (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value;
            if (query.length < 3) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Ketik minimal 3 huruf.</p>';
                return;
            }
            resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Mencari...</p>';
            debounceTimer = setTimeout(() => {
                fetch(`/admin/api/search-student?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        renderResults(data.data);
                    });
            }, 500);
        });

        function renderResults(santriList) {
            resultsContainer.innerHTML = '';
            if (!santriList || santriList.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #888;">Santri tidak ditemukan.</p>';
                return;
            }
            santriList.forEach(santri => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <div>
                        <strong>${santri.name}</strong><br>
                        <small>NIS: ${santri.nis || 'N/A'} | Asrama: ${santri.activeDormitory || 'N/A'}</small>
                    </div>
                    <button class="btn btn-primary impor-btn">+ Impor</button>
                `;
                item.querySelector('.impor-btn').dataset.santri = JSON.stringify(santri);
                resultsContainer.appendChild(item);
            });
        }
        
        resultsContainer.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('impor-btn')) {
                const btn = e.target;
                const santriData = JSON.parse(btn.dataset.santri);
                btn.textContent = 'Memproses...';
                btn.disabled = true;

                fetch('/admin/santri/impor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(santriData)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        btn.textContent = 'Berhasil';
                        btn.style.backgroundColor = '#28a745';
                    } else {
                        btn.textContent = result.message;
                        btn.style.backgroundColor = '#dc3545';
                    }
                });
            }
        });
    }
    new TomSelect('#filter-alamat',{
    plugins: ['remove_button'],
});
    const alamatInput = document.getElementById('filter-alamat-input');
    const alamatDataList = document.getElementById('alamat-list');
    let debounceTimer;

    alamatInput.addEventListener('keyup', function() {
        clearTimeout(debounceTimer);
        const query = this.value;

        if (query.length < 2) {
            return;
        }

        debounceTimer = setTimeout(() => {
            fetch(`/admin/api/search-wilayah?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    alamatDataList.innerHTML = ''; // Kosongkan saran lama
                    if (data.results) {
                        data.results.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.label;
                            alamatDataList.appendChild(option);
                        });
                    }
                });
        }, 500); // Jeda 500ms
    });
});
</script>
{% endblock %}