{% extends "_admin_layout.html" %}
{% block title %}Manajemen Santri per Wilayah{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h2">Manajemen Santri per Wilayah</h1>
</div>
<p>Halaman ini menampilkan daftar santri yang relevan dengan cakupan wilayah rombongan yang Anda kelola.</p>

<div class="row g-3 mb-4">
    <div class="col-lg-2 col-md-4 col-6"><div class="card p-3 shadow-sm text-center"><h6 class="text-muted">Total Putra</h6><p class="h3 mb-0">{{ stats.total_putra }}</p></div></div>
    <div class="col-lg-2 col-md-4 col-6"><div class="card p-3 shadow-sm text-center"><h6 class="text-muted">Putra Terdaftar</h6><p class="h3 mb-0 text-success">{{ stats.putra_terdaftar }}</p></div></div>
    <div class="col-lg-2 col-md-4 col-6"><div class="card p-3 shadow-sm text-center"><h6 class="text-muted">Putra Belum Daftar</h6><p class="h3 mb-0 text-danger">{{ stats.putra_belum_daftar }}</p></div></div>
    <div class="col-lg-2 col-md-4 col-6"><div class="card p-3 shadow-sm text-center"><h6 class="text-muted">Total Putri</h6><p class="h3 mb-0">{{ stats.total_putri }}</p></div></div>
    <div class="col-lg-2 col-md-4 col-6"><div class="card p-3 shadow-sm text-center"><h6 class="text-muted">Putri Terdaftar</h6><p class="h3 mb-0 text-success">{{ stats.putri_terdaftar }}</p></div></div>
    <div class="col-lg-2 col-md-4 col-6"><div class="card p-3 shadow-sm text-center"><h6 class="text-muted">Putri Belum Daftar</h6><p class="h3 mb-0 text-danger">{{ stats.putri_belum_daftar }}</p></div></div>
</div>

<div class="card">
    <div class="card-header">
        <h5>Daftar Santri Tersimpan (Total: {{ pagination.total }})</h5>
    </div>
    <div class="card-body">
        <form method="GET">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="nama" class="form-label">Nama Santri</label>
                    <input type="text" name="nama" id="nama" class="form-control" placeholder="Cari Nama..." value="{{ request.args.get('nama', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="jenis_kelamin" class="form-label">Jenis Kelamin</label>
                    <select name="jenis_kelamin" id="jenis_kelamin" class="form-select">
                        <option value="">-- Semua --</option>
                        <option value="PUTRA" {% if request.args.get('jenis_kelamin') == 'PUTRA' %}selected{% endif %}>Putra</option>
                        <option value="PUTRI" {% if request.args.get('jenis_kelamin') == 'PUTRI' %}selected{% endif %}>Putri</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status_santri" class="form-label">Status Santri</label>
                    <select name="status_santri" id="status_santri" class="form-select">
                        <option value="">-- Semua Status --</option>
                        <option value="Aktif" {% if request.args.get('status_santri') == 'Aktif' %}selected{% endif %}>Aktif</option>
                        <option value="Izin" {% if request.args.get('status_santri') == 'Izin' %}selected{% endif %}>Izin</option>
                        <option value="Partisipan" {% if request.args.get('status_santri') == 'Partisipan' %}selected{% endif %}>Partisipan</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status_daftar" class="form-label">Status Pendaftaran</label>
                    <select name="status_daftar" id="status_daftar" class="form-select">
                        <option value="">-- Semua --</option>
                        <option value="sudah" {% if request.args.get('status_daftar') == 'sudah' %}selected{% endif %}>Sudah Terdaftar</option>
                        <option value="belum" {% if request.args.get('status_daftar') == 'belum' %}selected{% endif %}>Belum Terdaftar</option>
                    </select>
                </div>
                <div class="col-12 text-end mt-3">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search me-2"></i>Filter</button>
                    <a href="{{ url_for('admin.manajemen_santri_wilayah') }}" class="btn btn-secondary"><i class="fas fa-undo me-2"></i>Reset</a>
                </div>
            </div>
        </form>
    </div>
    <div class="table-responsive">
    
    <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-dark">
            <tr>
                <th style="width: 3%;">No.</th>
                <th style="width: 20%;">Nama Santri & Jabatan</th>
                <th style="width: 15%;">Alamat</th>
                <th style="width: 20%;">Status Perjalanan & Pembayaran</th>
                <th style="width: 22%;">Alokasi Bus</th>
                <th style="width: 15%;">Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for santri in pagination.items %}
            {% set pendaftaran = pendaftaran_map.get(santri.id) %}
            <tr>
                <td>{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                <td>
                    <strong>{{ santri.nama }}</strong>
<br>
<small class="text-muted">
    {% if santri.nama_jabatan %}
        <span class="badge bg-info-subtle text-info-emphasis">{{ santri.nama_jabatan }}</span>
    {% else %}
        <span class="badge bg-secondary-subtle text-secondary-emphasis">Santri</span>
    {% endif %}

    {% if santri.jenis_kelamin == 'PUTRA' %}
        <span class="badge bg-primary-subtle text-primary-emphasis">Putra</span>
    {% elif santri.jenis_kelamin == 'PUTRI' %}
        <span class="badge bg-info-subtle text-info-emphasis">Putri</span>
    {% endif %}
</small>

                </td>
                <td>
                    <small>{{ santri.kabupaten }}</small>
                </td>
                
                {# Kolom Status Perjalanan & Pembayaran #}
                <td>
                    {% if pendaftaran %}
    <div>
        {% if pendaftaran.status_pulang == 'Tidak Ikut' %}
            <span class="badge bg-warning text-dark">Pulang: {{ pendaftaran.status_pulang }}</span>
        {% else %}
            <span class="badge bg-success">Pulang: {{ pendaftaran.status_pulang }}</span>
        {% endif %}
        <small class="text-muted fst-italic">({{ pendaftaran.metode_pembayaran_pulang or '-' }})</small>
    </div>
    <div class="mt-1">
        {% if pendaftaran.status_kembali == 'Tidak Ikut' %}
            <span class="badge bg-warning text-dark">Kembali: {{ pendaftaran.status_kembali }}</span>
        {% else %}
            <span class="badge bg-danger">Kembali: {{ pendaftaran.status_kembali }}</span>
        {% endif %}
        <small class="text-muted fst-italic">({{ pendaftaran.metode_pembayaran_kembali or '-' }})</small>
    </div>
{% else %}
    <span class="badge bg-light text-dark">Belum Terdaftar</span>
{% endif %}

                </td>

                {# Kolom Alokasi Bus #}
                <td>
                    {% if pendaftaran %}
                        <div>
                            <small class="text-muted">Pulang: 
                                {% if pendaftaran.bus_pulang %}
                                    <strong>{{ pendaftaran.bus_pulang.nama_armada }} ({{ pendaftaran.bus_pulang.nomor_lambung or 'N/A' }})</strong>
                                {% else %}
                                    <span class="text-danger">- Belum Ada -</span>
                                {% endif %}
                            </small>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">Kembali: 
                                {% if pendaftaran.bus_kembali %}
                                    <strong>{{ pendaftaran.bus_kembali.nama_armada }} ({{ pendaftaran.bus_kembali.nomor_lambung or 'N/A' }})</strong>
                                {% else %}
                                    <span class="text-danger">- Belum Ada -</span>
                                {% endif %}
                            </small>
                        </div>
                    {% else %}
                        <small class="text-muted">-</small>
                    {% endif %}
                </td>
                
                {# Kolom Aksi #}
                <td>
                    {% if pendaftaran %}
                        <a href="{{ url_for('admin.edit_pendaftaran', pendaftaran_id=pendaftaran.id) }}" class="btn btn-secondary btn-sm w-100">
                            <i class="fas fa-edit me-1"></i> Edit Detail
                        </a>
                    {% else %}
                         <a href="{{ url_for('admin.pendaftaran_rombongan', santri_id=santri.id) }}" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-plus me-1"></i> Daftarkan
                         </a>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center p-4">Tidak ada santri yang cocok dengan filter Anda.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}