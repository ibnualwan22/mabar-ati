{% extends "_admin_layout.html" %}
{% block title %}Tambah Partisipan Baru{% endblock %}

{% block content %}
<style>
    /* Menggunakan kembali style modern dari halaman perizinan */
    :root {
        --primary-blue: #2563eb;
        --light-blue: #60a5fa;
        --dark-blue: #1d4ed8;
        --accent-blue: #3b82f6;
        --background: #f8fafc;
        --card-bg: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
    }
    .page-container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
    .page-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
        color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .page-header h1 { font-size: 2.25rem; font-weight: 700; margin: 0; }
    .page-header a { color: white; opacity: 0.9; text-decoration: none; transition: opacity 0.2s; }
    .page-header a:hover { opacity: 1; }
    .form-card {
        background: var(--card-bg); border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 2rem;
    }
    .form-card-header {
        background: var(--light-blue); color: white; padding: 1.25rem 1.5rem;
        border-radius: 12px 12px 0 0;
    }
    .form-card-header h5 { margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .form-card-body { padding: 1.5rem; background: #fafbff; }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.9rem; display: block; }
    .form-control {
        border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem;
        font-size: 0.9rem; transition: all 0.3s ease; background: white; width: 100%;
    }
    .form-control:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); outline: none;
    }
    .btn-primary {
        background: var(--primary-blue); border: none; border-radius: 8px; padding: 0.75rem 1.5rem;
        font-weight: 600; color: white; transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
    }
    .btn-primary:hover {
        background: var(--dark-blue); transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .info-box {
        background: #eef2ff;
        border-left: 4px solid var(--accent-blue);
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 8px;
        color: var(--text-primary);
    }
</style>

<div class="page-container">
    <div class="page-header">
        <h1>Tambah Partisipan Baru</h1>
        <a href="{{ url_for('admin.data_partisipan') }}">&larr; Kembali ke Data Partisipan</a>
    </div>

    {% if current_user.role.name in ['Korpus', 'PJ Acara', 'Sekretaris', 'Korpuspi'] %}
    <div class="form-card">
        <div class="form-card-header">
            <h5><i class="fas fa-user-plus me-2"></i>Tambah Manual (Satu per Satu)</h5>
        </div>
        <div class="form-card-body">
            <form method="POST">
                {{ manual_form.hidden_tag() }}
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="select-santri-partisipan">Pilih Santri (Bisa Lebih Dari 1)</label>
                            {{ manual_form.santri_ids(id="select-santri-partisipan", multiple=True, placeholder="-- Cari Santri Aktif --") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ manual_form.kategori.label(class="form-label") }}
                            {{ manual_form.kategori(class="form-control", placeholder=manual_form.kategori.description) }}
                        </div>
                    </div>
                </div>
                <div id="info-santri" class="info-box" style="display: none;"></div>
                <div class="text-end mt-4">
                    <button type="submit" name="submit_manual" class="btn btn-primary">
                        {{ manual_form.submit.label.text }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="form-card">
        <div class="form-card-header">
            <h5><i class="fas fa-file-excel me-2"></i>Impor Massal dari Excel</h5>
        </div>
        <div class="form-card-body">
            <form method="POST" enctype="multipart/form-data">
                {{ import_form.hidden_tag() }}
                <p class="text-muted">Unggah file Excel (.xlsx) dengan satu kolom bernama <strong>NIS</strong>.</p>
                <div class="row g-3">
                    <div class="col-md-6">{{ import_form.file(class="form-control") }}</div>
                    <div class="col-md-4">{{ import_form.kategori(class="form-control", placeholder=import_form.kategori.description) }}</div>
                    <div class="col-md-2">
                        <button type="submit" name="submit_import" class="btn btn-success w-100">
                            {{ import_form.submit.label.text }}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const infoSantriDiv = document.getElementById('info-santri');

  const ts = new TomSelect('#select-santri-partisipan', {
    valueField: 'id',
    labelField: 'nama',
    searchField: 'nama',
    maxItems: null,                    // <- multi select tanpa batas
    persist: false,
    plugins: ['remove_button'],        // tombol x untuk hapus item terpilih
    preload: false,
    loadThrottle: 300,
    load: (query, callback) => {
      const url = `/admin/api/search-santri-for-partisipan?q=${encodeURIComponent(query||'')}`;
      fetch(url)
        .then(r => r.json())
        .then(json => callback(json.results || []))
        .catch(() => callback());
    },
    render: {
      option(data, escape) {
        return `
          <div class="d-flex align-items-center py-2 px-3">
            <div class="avatar-circle me-3" style="width:32px;height:32px;background:var(--primary-blue);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:.9rem;">
              ${escape((data.nama||'?')[0])}
            </div>
            <div>
              <div class="fw-medium">${escape(data.nama || 'Tanpa nama')}</div>
              <small class="text-muted">${escape(data.asrama || 'N/A')} • ${escape(data.kabupaten || 'N/A')}</small>
            </div>
          </div>
        `;
      },
      item(data, escape) {
        return `
          <div class="d-flex align-items-center">
            <div class="avatar-circle me-2" style="width:24px;height:24px;background:var(--primary-blue);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:.8rem;">
              ${escape((data.nama||'?')[0])}
            </div>
            <span>${escape(data.nama || 'Tanpa nama')}</span>
          </div>
        `;
      }
    },
    onChange(values) {
      // values = array id santri yang terpilih
      if (!values || values.length === 0) {
        infoSantriDiv.style.display = 'none';
        infoSantriDiv.innerHTML = '';
        return;
      }
      // ambil data lengkap dari cache options TomSelect
      const items = values.map(v => this.options[v]).filter(Boolean);
      infoSantriDiv.style.display = 'block';
      infoSantriDiv.innerHTML = `
        <strong>Santri terpilih (${items.length}):</strong>
        <ul style="margin: .5rem 0 0 1rem">
          ${items.map(s => `
            <li>
              <b>${s.nama || '-'}</b>
              <small class="text-muted"> — ${s.asrama || '-'} • ${s.kelas_formal || '-'} • ${s.kelas_ngaji || '-'}</small>
            </li>
          `).join('')}
        </ul>
      `;
    }
  });
});
</script>

{% endblock %}