{% extends "_admin_layout.html" %}
{% block title %}Manajemen Rombongan{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-users text-primary me-2"></i>Manajemen Rombongan
    </h1>
    {% if current_user.role.name == 'Korpus' %}
        <a href="{{ url_for('admin.tambah_rombongan') }}" class="btn btn-primary btn-lg shadow-sm">
            <i class="fas fa-plus me-2"></i>Tambah Rombongan Baru
        </a>
    {% endif %}
</div>

{% if not semua_rombongan and current_user.role.name == 'Korpus' %}
<div class="alert alert-info d-flex justify-content-between align-items-center shadow-sm border-0">
    <div>
        <i class="fas fa-info-circle me-2"></i>
        <span>Edisi ini belum memiliki rombongan. Anda bisa menyalin data dari edisi sebelumnya.</span>
    </div>
    <form method="POST" action="{{ url_for('admin.salin_rombongan') }}" onsubmit="return confirm('Anda yakin ingin menyalin semua rombongan dari edisi sebelumnya?');">
        <button type="submit" class="btn btn-success shadow-sm">
            <i class="fas fa-copy me-2"></i>Salin Rombongan
        </button>
    </form>
</div>
{% endif %}

<div class="card mb-4 shadow-sm border-0">
    <div class="card-body bg-light">
        <form method="GET" class="row g-3 align-items-center">
            <div class="col-md-10">
                <div class="input-group">
                    <span class="input-group-text border-0 bg-white">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" name="q" class="form-control border-start-0" placeholder="Cari nama rombongan..." value="{{ request.args.get('q', '') }}">
                </div>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100 shadow-sm">
                    <i class="fas fa-search me-1"></i>Cari
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row g-4">
    {% for rombongan in semua_rombongan %}
    <div class="col-lg-6">
        <div class="card h-100 shadow border-0 position-relative overflow-hidden">
            <!-- Decorative element -->
            <div class="position-absolute top-0 end-0 bg-primary opacity-10" style="width: 100px; height: 100px; border-radius: 50%; transform: translate(50%, -50%);"></div>
            
            <div class="card-header bg-gradient bg-primary text-white border-0 position-relative">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold">
                            <i class="fas fa-map-marker-alt me-2"></i>{{ rombongan.nama_rombongan }}
                        </h5>
                        <small class="opacity-75">Total Peserta: {{ rombongan.pendaftar_pulang|length + rombongan.pendaftar_kembali|length }}</small>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="badge bg-light text-primary rounded-pill me-2 shadow-sm">
                        <i class="fas fa-arrow-right me-1"></i>{{ rombongan.pendaftar_pulang|length }} Pulang
                    </span>
                    <span class="badge bg-light text-primary rounded-pill shadow-sm">
                        <i class="fas fa-arrow-left me-1"></i>{{ rombongan.pendaftar_kembali|length }} Pergi
                    </span>
                </div>
            </div>
            
            <div class="card-body p-4">
                <!-- PJ Section -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="bg-light rounded-3 p-3 h-100">
                            <h6 class="text-primary fw-bold mb-2">
                                <i class="fas fa-user-tie me-2"></i>PJ Putra
                            </h6>
                            <p class="mb-1 small">
                                <i class="fas fa-user me-2 text-muted"></i>{{ rombongan.penanggung_jawab_putra or 'Belum diatur' }}
                            </p>
                            <p class="mb-0 small">
                                <i class="fab fa-whatsapp me-2 text-success"></i>{{ rombongan.kontak_person_putra or 'Belum diatur' }}
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light rounded-3 p-3 h-100">
                            <h6 class="text-info fw-bold mb-2">
                                <i class="fas fa-user-tie me-2"></i>PJ Putri
                            </h6>
                            <p class="mb-1 small">
                                <i class="fas fa-user me-2 text-muted"></i>{{ rombongan.penanggung_jawab_putri or 'Belum diatur' }}
                            </p>
                            <p class="mb-0 small">
                                <i class="fab fa-whatsapp me-2 text-success"></i>{{ rombongan.kontak_person_putri or 'Belum diatur' }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Payment Info -->
                <div class="bg-warning bg-opacity-10 rounded-3 p-3 mb-4">
                    <h6 class="text-warning-emphasis fw-bold mb-2">
                        <i class="fas fa-credit-card me-2"></i>Informasi Pembayaran
                    </h6>
                    <p class="mb-0 small">{{ rombongan.nomor_rekening or 'Informasi rekening belum diatur.' }}</p>
                </div>

                <!-- Schedule -->
                <div class="bg-success bg-opacity-10 rounded-3 p-3 mb-4">
                    <h6 class="text-success-emphasis fw-bold mb-2">
                        <i class="fas fa-calendar-alt me-2"></i>Jadwal Perjalanan
                    </h6>
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1 small">
                                <i class="fas fa-arrow-right text-danger me-2"></i><strong>Pulang:</strong>
                            </p>
                            <p class="mb-0 small text-muted">{{ rombongan.jadwal_pulang|datetime_wib if rombongan.jadwal_pulang else 'Belum diatur' }}</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1 small">
                                <i class="fas fa-arrow-left text-primary me-2"></i><strong>Kembali:</strong>
                            </p>
                            <p class="mb-0 small text-muted">{{ rombongan.jadwal_berangkat|datetime_wib if rombongan.jadwal_berangkat else 'Belum diatur' }}</p>
                        </div>
                    </div>
                </div>

                <!-- Tariff Section -->
                <div class="bg-info bg-opacity-10 rounded-3 p-3">
                    <h6 class="text-info-emphasis fw-bold mb-3">
                        <i class="fas fa-money-bill-wave me-2"></i>Tarif Titik Turun/Jemput
                    </h6>
                    <div class="row g-2">
                        {% for tarif in rombongan.tarifs %}
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center bg-white rounded-2 p-2 shadow-sm">
                                    <span class="small fw-medium">{{ tarif.titik_turun }}</span>
                                    <span class="badge bg-success fw-bold">Rp {{ "{:,.0f}".format(tarif.harga_bus + tarif.fee_korda + 10000).replace(',', '.') }}</span>
                                </div>
                            </div>
                        {% else %}
                            <div class="col-12">
                                <div class="text-center text-muted small py-2">
                                    <i class="fas fa-exclamation-circle me-1"></i>Belum ada data tarif
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="card-footer bg-light border-0">
                <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('admin.daftar_peserta', rombongan_id=rombongan.id) }}" class="btn btn-primary btn-sm shadow-sm">
                            <i class="fas fa-users me-1"></i>Lihat Peserta
                        </a>
                        
                        {% if rombongan.buses %}
                        <div class="btn-group">
                            <button type="button" class="btn btn-info btn-sm dropdown-toggle shadow-sm" data-bs-toggle="dropdown">
                                <i class="fas fa-bus me-1"></i>Manifest Bus
                            </button>
                            <ul class="dropdown-menu">
                                {% for bus in rombongan.buses %}
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('admin.detail_bus', bus_id=bus.id) }}">
                                            <i class="fas fa-bus me-2 text-muted"></i>{{ bus.nama_armada }} - {{ bus.nomor_lambung or bus.plat_nomor }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-2">
                        {% if current_user.role.name == 'Korpus', 'Sekretaris', 'Korpuspi' or (current_user.role.name == 'Korda' and rombongan in current_user.active_managed_rombongan) %}
                            <a href="{{ url_for('admin.edit_rombongan', id=rombongan.id) }}" class="btn btn-outline-secondary btn-sm shadow-sm">
                                <i class="fas fa-edit me-1"></i>Edit
                            </a>
                        {% endif %}
                        
        {% if current_user.role.name in ['Korpus', 'Korpuspi', 'Sekretaris'] %}
                            <form method="POST" action="{{ url_for('admin.hapus_rombongan', id=rombongan.id) }}" style="display:inline;" onsubmit="return confirm('Anda yakin?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm shadow-sm">
                                    <i class="fas fa-trash me-1"></i>Hapus
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info border-0 shadow-sm text-center py-5">
            <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
            <h5>Belum Ada Data Rombongan</h5>
            <p class="mb-0">Belum ada data rombongan untuk edisi ini. Silakan tambah rombongan baru atau salin dari edisi sebelumnya.</p>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}