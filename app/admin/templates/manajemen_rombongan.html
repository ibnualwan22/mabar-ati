{% extends "_admin_layout.html" %}

{% block title %}Manajemen Rombongan{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Manajemen Rombongan</h1>
        {% if current_user.role.name == 'Korpus' %}
            <a href="{{ url_for('admin.tambah_rombongan') }}" class="btn btn-primary">+ Tambah Rombongan Baru</a>
        {% endif %}
    </div>
    
    <table class="table table-striped table-hover align-middle">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nama Rombongan</th>
                <th>Penanggung Jawab</th>
                <th>Jadwal Berangkat</th>
                <th>Kuota</th>
                <th>Peserta</th>
                <th>Manifest Bus</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for rombongan in semua_rombongan %}
            <tr>
                <td>{{ rombongan.id }}</td>
                <td>{{ rombongan.nama_rombongan }}</td>
                <td>{{ rombongan.penanggung_jawab }}</td>
                <td>{{ rombongan.jadwal_keberangkatan.strftime('%d %b %Y %H:%M') if rombongan.jadwal_keberangkatan else '-' }}</td>
                <td>{{ rombongan.pendaftar|length }} / {{ rombongan.buses|sum(attribute='kuota') or '0' }}</td>
                <td>
                <a href="{{ url_for('admin.daftar_peserta', rombongan_id=rombongan.id) }}" class="btn btn-primary btn-sm">Lihat Peserta ({{ rombongan.pendaftar|length }})</a>
                </td>
                <td>
                    {% if rombongan.buses %}
                    <div class="dropdown">
                        <button class="btn btn-info btn-sm dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                            Lihat Manifest
                        </button>
                        <ul class="dropdown-menu">
                            {% for bus in rombongan.buses %}
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('admin.detail_bus', bus_id=bus.id) }}">
                                        {{ bus.nama_armada }} - {{ bus.nomor_lambung or bus.plat_nomor }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <span class="text-muted">Belum ada bus</span>
                    {% endif %}
                </td>
                <td>
    {% if current_user.role.name == 'Korpus' or (current_user.role.name == 'Korda' and rombongan in current_user.managed_rombongan) %}
        <a href="{{ url_for('admin.edit_rombongan', id=rombongan.id) }}" class="btn btn-secondary btn-sm">Edit</a>
    {% endif %}

    {% if current_user.role.name == 'Korpus' %}
        <form method="POST" action="{{ url_for('admin.hapus_rombongan', id=rombongan.id) }}" style="display:inline;" onsubmit="return confirm('Anda yakin?');">
            <button type="submit" class="btn btn-danger btn-sm">Hapus</button>
        </form>
    {% endif %}
</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center">Belum ada data rombongan untuk edisi ini.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}