{% extends "_admin_layout.html" %}

{% block title %}Dashboard Utama{% endblock %}

{% block content %}
<style>
    .stat-card-link { text-decoration: none; color: inherit; display: block; height: 100%; }
    .stat-card-link .card:hover { transform: translateY(-5px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .stat-card { transition: all 0.3s ease; height: 100%;}
    .stat-number { font-size: 2.2rem; font-weight: 700; }
    .chart-container { position: relative; height: 300px; width: 100%; }
    .gelombang-card { border-left: 4px solid; }
    .gelombang-1 { border-left-color: #007bff !important; }
    .gelombang-2 { border-left-color: #28a745 !important; }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard Utama</h1>
</div>

{% if not active_edisi %}
    <div class="alert alert-warning">Tidak ada edisi yang aktif. Silakan aktifkan satu edisi di Manajemen Edisi.</div>
{% else %}
    <!-- Kartu Statistik Utama -->
    <div class="row g-4 mb-4">
        <div class="col-lg col-md-6">
            <a href="{{ url_for('admin.daftar_peserta_global') }}" class="stat-card-link">
                <div class="card shadow-sm stat-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Peserta Terdaftar</h6>
                        <p class="card-text stat-number text-primary">{{ stats.total_peserta }}</p>
                    </div>
                </div>
            </a>
        </div>
        
        {% if is_full_access or is_regional_access %}
        <div class="col-lg col-md-6">
            {% if current_user.role.name in ['Korwil', 'Korda'] %}
                <a href="{{ url_for('admin.manajemen_santri_wilayah', rombongan_id='belum_terdaftar', alamat=managed_regions) }}" class="stat-card-link">
            {% else %}
                <a href="{{ url_for('admin.manajemen_santri_wilayah', rombongan_id='belum_terdaftar') }}" class="stat-card-link">
            {% endif %}
                <div class="card shadow-sm stat-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Santri Belum Daftar</h6>
                        <p class="card-text stat-number">{{ stats.santri_belum_terdaftar }}</p>
                    </div>
                </div>
            </a>
        </div>
        
        <div class="col-lg col-md-6">
            <a href="{{ url_for('admin.perizinan') }}" class="stat-card-link">
                <div class="card shadow-sm stat-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Total Santri Izin</h6>
                        <p class="card-text stat-number text-secondary">{{ stats.total_izin }}</p>
                    </div>
                </div>
            </a>
        </div>
        
        <div class="col-lg col-md-6">
            <a href="{{ url_for('admin.data_partisipan') }}" class="stat-card-link">
                <div class="card shadow-sm stat-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Total Partisipan</h6>
                        <p class="card-text stat-number text-info">{{ stats.total_partisipan }}</p>
                    </div>
                </div>
            </a>
        </div>
        
        <div class="col-lg col-md-6">
            <a href="{{ url_for('admin.manajemen_wisuda') }}" class="stat-card-link">
                <div class="card shadow-sm stat-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Total Wisudawan</h6>
                        <p class="card-text stat-number text-success">{{ stats.total_wisuda }}</p>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Kartu Statistik Gelombang -->
    <div class="row g-4 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm stat-card gelombang-card gelombang-1">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Pulang Gelombang 1</h6>
                    <p class="card-text stat-number text-primary">{{ stats.pulang_gelombang_1 }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm stat-card gelombang-card gelombang-2">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Pulang Gelombang 2</h6>
                    <p class="card-text stat-number text-success">{{ stats.pulang_gelombang_2 }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm stat-card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Total Kembali</h6>
                    <p class="card-text stat-number text-warning">{{ stats.total_kembali }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if show_filter %}
    <!-- Filter Rombongan -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" id="filterForm">
                <div class="row align-items-end">
                    <div class="col-md-10">
                        <label for="rombongan_id" class="form-label fw-bold">Tampilkan Grafik untuk Rombongan:</label>
                        <select name="rombongan_id" id="rombongan_id" class="form-select" onchange="this.form.submit()">
                            {% if is_full_access %}
                            <option value="">-- Semua Rombongan --</option>
                            {% else %}
                            <option value="">-- Semua Rombongan yang Dikelola --</option>
                            {% endif %}
                            {% for r in semua_rombongan %}
                                <option value="{{ r.id }}" {% if r.id == selected_rombongan_id %}selected{% endif %}>
                                    {{ r.nama_rombongan }}
                                    {% if r.gelombang %} - Gelombang {{ r.gelombang }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary w-100">Reset</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Grafik (hanya untuk yang punya akses) -->
    {% if is_full_access or is_regional_access %}
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <strong>Alokasi Dana</strong>
                    {% if selected_rombongan_id %}
                        {% for r in semua_rombongan %}
                            {% if r.id == selected_rombongan_id %}
                                <small class="text-muted"> - {{ r.nama_rombongan }}</small>
                            {% endif %}
                        {% endfor %}
                    {% elif is_regional_access %}
                        <small class="text-muted"> - Wilayah yang Dikelola</small>
                    {% endif %}
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div class="chart-container">
                        <canvas id="alokasiChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <strong>Status Pembayaran</strong>
                    {% if selected_rombongan_id %}
                        {% for r in semua_rombongan %}
                            {% if r.id == selected_rombongan_id %}
                                <small class="text-muted"> - {{ r.nama_rombongan }}</small>
                            {% endif %}
                        {% endfor %}
                    {% elif is_regional_access %}
                        <small class="text-muted"> - Wilayah yang Dikelola</small>
                    {% endif %}
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if show_filter and (is_full_access or is_regional_access) %}
        const dataAlokasi = {{ chart_data_alokasi | tojson | safe }};
        const dataStatus = {{ chart_data_status | tojson | safe }};
        
        const ctxAlokasi = document.getElementById('alokasiChart');
        if (ctxAlokasi && (dataAlokasi.bus > 0 || dataAlokasi.korda > 0 || dataAlokasi.pondok > 0)) {
            new Chart(ctxAlokasi, {
                type: 'doughnut',
                data: {
                    labels: ['Biaya Bus', 'Fee Korda', 'Fee Pondok'],
                    datasets: [{
                        label: 'Rp',
                        data: [dataAlokasi.bus, dataAlokasi.korda, dataAlokasi.pondok],
                        backgroundColor: ['rgba(63, 81, 181, 0.8)','rgba(255, 152, 0, 0.8)','rgba(76, 175, 80, 0.8)'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'top' }, 
                        tooltip: { 
                            callbacks: { 
                                label: function(context) { 
                                    let label = context.label || ''; 
                                    if (label) { label += ': '; } 
                                    if (context.parsed !== null) { 
                                        label += new Intl.NumberFormat('id-ID', { 
                                            style: 'currency', 
                                            currency: 'IDR', 
                                            minimumFractionDigits: 0 
                                        }).format(context.parsed); 
                                    } 
                                    return label; 
                                } 
                            } 
                        } 
                    } 
                }
            });
        } else if (ctxAlokasi) {
            ctxAlokasi.getContext('2d').fillText('Tidak ada data', ctxAlokasi.width/2, ctxAlokasi.height/2);
        }
        
        const ctxStatus = document.getElementById('statusChart');
        if (ctxStatus && (dataStatus.lunas > 0 || dataStatus.belum_lunas > 0)) {
            new Chart(ctxStatus, {
                type: 'pie',
                data: {
                    labels: ['Lunas', 'Belum Lunas'],
                    datasets: [{
                        label: 'Rp',
                        data: [dataStatus.lunas, dataStatus.belum_lunas],
                        backgroundColor: ['rgba(33, 150, 243, 0.8)','rgba(244, 67, 54, 0.8)'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'top' }, 
                        tooltip: { 
                            callbacks: { 
                                label: function(context) { 
                                    let label = context.label || ''; 
                                    if (label) { label += ': '; } 
                                    if (context.parsed !== null) { 
                                        label += new Intl.NumberFormat('id-ID', { 
                                            style: 'currency', 
                                            currency: 'IDR', 
                                            minimumFractionDigits: 0 
                                        }).format(context.parsed); 
                                    } 
                                    return label; 
                                } 
                            } 
                        } 
                    } 
                }
            });
        } else if (ctxStatus) {
            ctxStatus.getContext('2d').fillText('Tidak ada data', ctxStatus.width/2, ctxStatus.height/2);
        }
        {% endif %}
    });
</script>
{% endblock %}