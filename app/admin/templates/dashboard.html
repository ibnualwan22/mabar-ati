{% extends "_admin_layout.html" %}

{% block title %}Dashboard Utama{% endblock %}

{% block content %}
<style>
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .stat-card { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 20px; border-radius: 8px; }
    .stat-card h3 { margin-top: 0; color: #495057; }
    .stat-card .stat-number { font-size: 2.5em; font-weight: bold; color: #007bff; }
    .info-box { background-color: #fefefe; border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-top: 30px; }
    .warning-box { background-color: #fff3cd; border-color: #ffeeba; padding: 20px; border-radius: 8px; margin-top: 20px; }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    {% if is_arsip %}
        <h1 class="h2">Arsip Dashboard: {{ arsip_edisi_nama }}</h1>
        <a href="{{ url_for('admin.riwayat_edisi') }}" class="btn btn-secondary">&larr; Kembali ke Riwayat</a>
    {% else %}
        <h1 class="h2">Dashboard Utama</h1>
    {% endif %}
</div>

{% if stats.pendaftar_terlambat %}
<div class="warning-box">
    <h4><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> 
        Perhatian: Ada {{ stats.pendaftar_terlambat|length }} santri terlambat membayar!
    </h4>
    <p>Berikut adalah daftar santri yang belum lunas dan sudah melewati batas pembayaran:</p>
    <ul>
        {% for p in stats.pendaftar_terlambat %}
        <li><strong>{{ p.santri.nama }}</strong> (Rombongan: {{ p.rombongan.nama_rombongan }})</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <a href="{{ url_for('admin.daftar_peserta_global') }}" class="stat-card-link">
            <div class="card text-center h-100">
                <div class="card-header">Peserta Rombongan</div>
                <div class="card-body">
                    <h5 class="card-title stat-number text-primary">{{ stats.total_peserta }}</h5>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{{ url_for('admin.manajemen_santri', rombongan_id='belum_terdaftar') }}" class="stat-card-link">
            <div class="card text-center h-100">
                <div class="card-header">Santri Belum Terdaftar</div>
                <div class="card-body">
                    <h5 class="card-title stat-number">{{ stats.santri_belum_terdaftar }}</h5>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{{ url_for('admin.perizinan') }}" class="stat-card-link">
            <div class="card text-center h-100">
                <div class="card-header">Total Santri Izin</div>
                <div class="card-body">
                    <h5 class="card-title stat-number text-secondary">{{ stats.total_izin }}</h5>
                </div>
            </div>
        </a>
    </div>
</div>

{% if current_user.role.name in ['Korpus', 'Korwil', 'Korda'] %}
<div class="info-box">
    <h2>Ringkasan Keuangan</h2>
    <div class="stat-grid">
    <div class="stat-card">
        <h3>Total Pemasukan</h3>
        <p class="stat-number">Rp {{ "{:,.0f}".format(stats.total_pemasukan).replace(',', '.') }}</p>
    </div>
    <div class="stat-card" style="border-left: 5px solid #28a745;">
        <h3>Diterima (Lunas)</h3>
        <p class="stat-number" style="color: #28a745;">Rp {{ "{:,.0f}".format(stats.total_lunas).replace(',', '.') }}</p>
    </div>
    <div class="stat-card" style="border-left: 5px solid #dc3545;">
        <h3>Sisa Tagihan</h3>
        <p class="stat-number" style="color: #dc3545;">Rp {{ "{:,.0f}".format(stats.total_belum_lunas).replace(',', '.') }}</p>
    </div>
</div>
    <p style="margin-top: 20px;"><strong>Metode Pembayaran:</strong> {{ stats.jumlah_cash }} Cash / {{ stats.jumlah_transfer }} Transfer</p>
</div>
{% endif %}

<div class="info-box">
    <h2>Perincian Rombongan</h2>
    <table>
        <thead>
            <tr>
                <th>Nama Rombongan</th>
                <th>Kuota</th>
                <th>Total Peserta</th>
                <th>Lunas</th>
                <th>Belum Lunas</th>
                <th>Total Pemasukan</th>
            </tr>
        </thead>
        <tbody>
            {% for rombongan in semua_rombongan %}
            <tr>
                <td><strong>{{ rombongan.nama_rombongan }}</strong></td>
                <td>{{ rombongan.pendaftar|length }} / {{ rombongan.kuota or 'âˆž' }}</td>
                <td>{{ rombongan.pendaftar|length }}</td>
                <td>{{ rombongan.pendaftar|selectattr('status_pembayaran', 'equalto', 'Lunas')|list|length }}</td>
                <td>{{ rombongan.pendaftar|selectattr('status_pembayaran', 'equalto', 'Belum Lunas')|list|length }}</td>
                <td>Rp {{ "{:,.0f}".format(rombongan.pendaftar|sum(attribute='total_biaya')).replace(',', '.') }}</td>            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}