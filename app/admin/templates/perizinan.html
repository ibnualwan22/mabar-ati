{% extends "_admin_layout.html" %}
{% block title %}Manajemen Perizinan{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h2">Manajemen Perizinan</h1>
</div>
<p>Gunakan halaman ini untuk mencatat dan memantau santri yang izin tidak mengikuti kegiatan perpulangan.</p>

{% if current_user.role.name in ['Korpus', 'Keamanan'] %}
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-plus-circle me-2"></i>Form Izin Baru</h5>
        </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin.perizinan') }}">
        {{ form.hidden_tag() }}
        <div class="form-group form-grid">
            <label for="select-santri-izin">Pilih Santri</label>
            <div>
                <select id="select-santri-izin" placeholder="-- Cari Santri Aktif --"></select>
                {{ form.santri() }} </div>
        </div>
        <div class="form-group form-grid">
            {{ form.tanggal_berakhir.label }}
            {{ form.tanggal_berakhir() }}
        </div>
        <div class="form-group form-grid">
            {{ form.keterangan.label }}
            {{ form.keterangan(rows=3) }}
        </div>
        <div class="form-group" style="padding-left: 165px;">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
 </div>
</div>
{% endif %}
<hr>

    <ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link {% if view_mode == 'aktif' %}active{% endif %}" href="{{ url_for('admin.perizinan', view='aktif') }}">Izin Aktif</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if view_mode == 'riwayat' %}active{% endif %}" href="{{ url_for('admin.perizinan', view='riwayat') }}">Riwayat Izin</a>
    </li>
</ul>

<div class="card">
    <div class="card-body">
        <form method="GET" class="mb-3">
             <input type="hidden" name="view" value="{{ view_mode }}">
            <div class="input-group">
                <input type="text" name="nama" class="form-control" placeholder="Filter nama santri..." value="{{ request.args.get('nama', '') }}">
                <button type="submit" class="btn btn-primary">Cari</button>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Nama Santri</th>
                        <th>Asrama</th>
                        <th>Alamat</th>
                        <th>Izin Sampai</th>
                        <th>Keterangan</th>
                        {% if view_mode == 'aktif' and current_user.role.name in ['Korpus', 'Keamanan'] %}
                        <th>Aksi</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for izin in semua_izin %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ izin.santri.nama }}</td>
                        <td>{{ izin.santri.asrama }}</td>
                        <td>{{ izin.santri.kabupaten }}</td>
                        <td>{{ izin.tanggal_berakhir|date_wib }}</td>
                        <td>{{ izin.keterangan }}</td>
                        {% if view_mode == 'aktif' and current_user.role.name in ['Korpus', 'Keamanan'] %}
                        <td>
                            <a href="{{ url_for('admin.edit_izin', izin_id=izin.id) }}" class="btn btn-secondary btn-sm">Edit</a>
                            <form method="POST" action="{{ url_for('admin.cabut_izin', izin_id=izin.id) }}" style="display:inline;" onsubmit="return confirm('Anda yakin?');">
                                <button type="submit" class="btn btn-danger btn-sm">Cabut Izin</button>
                            </form>
                        </td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center">Tidak ada data izin untuk ditampilkan.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
    
    
    <script>

document.addEventListener('DOMContentLoaded', function() {
    const hiddenSantriInput = document.getElementById('santri');

    new TomSelect('#select-santri-izin', {
        valueField: 'id',
        labelField: 'nama',
        searchField: 'nama',
        load: (query, callback) => {
            const url = `/admin/api/search-active-santri?q=${encodeURIComponent(query)}`;
            fetch(url)
                .then(response => response.json())
                .then(json => {
                    callback(json.results);
                }).catch(() => {
                    callback();
                });
        },
        onChange: (value) => {
            hiddenSantriInput.value = value;
        }
    });
});
</script>
{% endblock %}